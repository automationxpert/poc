<!DOCTYPE html>
<html lang="en" data-theme="system">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="tab-title">Loading...</title>
    <style>
        :root {
            --bg-color: #f1f5f9; --card-bg: #ffffff; --text-color: #0f172a;
            --accent-color: #2563eb; --border-color: #e2e8f0; --hover-bg: #f8fafc;
            --red: #ef4444; --orange: #f97316; --yellow: #eab308; --green: #22c55e;
        }
        [data-theme="dark"] {
            --bg-color: #020617; --card-bg: #1e293b; --text-color: #f1f5f9;
            --accent-color: #38bdf8; --border-color: #334155; --hover-bg: #334155;
        }
        @media (prefers-color-scheme: dark) {
            [data-theme="system"] {
                --bg-color: #020617; --card-bg: #1e293b; --text-color: #f1f5f9;
                --accent-color: #38bdf8; --border-color: #334155; --hover-bg: #334155;
            }
        }

        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        .header { background: var(--card-bg); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .container { max-width: 1600px; margin: 0 auto; padding: 1.5rem; flex: 1; width: 100%; box-sizing: border-box; }

        /* Filter Panel */
        .filter-panel { background: var(--card-bg); padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #64748b; }
        
        /* Action Bar */
        .action-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 1.5rem; background: var(--card-bg); padding: 0.75rem; border-radius: 12px; border: 1px solid var(--border-color); position: sticky; top: 80px; z-index: 900; }
        input[type="text"], select { padding: 0.6rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); outline: none; font-family: inherit; }

        /* Table */
        .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { padding: 1rem; font-size: 0.75rem; text-transform: uppercase; background: var(--hover-bg); border-bottom: 2px solid var(--border-color); cursor: pointer; }
        td { padding: 1rem; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; }

        /* Footer */
        footer { background: var(--card-bg); border-top: 1px solid var(--border-color); padding: 2.5rem 2rem; margin-top: 3rem; color: #64748b; }
        .footer-content { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; }

        .btn { padding: 0.6rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); cursor: pointer; font-size: 0.8rem; font-weight: 600; }
        .badge { padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 0.75rem; }
        .health-green { background: #dcfce7; color: #166534; } .health-red { background: #fee2e2; color: #991b1b; }

        /* API Mode styling */
        pre { background: #1e293b; color: #f1f5f9; padding: 2rem; border-radius: 12px; overflow: auto; margin: 2rem; line-height: 1.5; }
    </style>
</head>
<body>

<div id="dashboard-ui">
    <div class="header">
        <div>
            <h2 id="display-title" style="margin:0; font-size: 1.3rem;">...</h2>
            <span id="update-time" style="font-size: 0.75rem; opacity: 0.7;">Syncing...</span>
        </div>
        <div style="display:flex; gap:12px;">
            <select id="theme-select" class="btn" onchange="setTheme(this.value)">
                <option value="system">üåì System</option>
                <option value="light">‚òÄÔ∏è Light</option>
                <option value="dark">üåô Dark</option>
            </select>
            <button class="btn" onclick="exportToCSV()">üìÇ Export CSV</button>
        </div>
    </div>

    <div class="container">
        <div class="filter-panel">
            <div class="filter-group">
                <label>Filter Column</label>
                <select id="filter-col" onchange="applyCurrentView()"><option value="all">Search All Fields</option></select>
            </div>
            <div class="filter-group">
                <label>Match Mode</label>
                <select id="match-mode" onchange="applyCurrentView()">
                    <option value="like">Matches (Like)</option>
                    <option value="exact">Exact Equal</option>
                </select>
            </div>
            <div class="filter-group" style="flex-direction: row; align-items: center; padding-top: 15px;">
                <input type="checkbox" id="case-sensitive" onchange="applyCurrentView()">
                <label for="case-sensitive" style="margin-left:5px; cursor:pointer;">Case Sensitive</label>
            </div>
            <div style="flex-grow: 1;"></div>
            <div class="filter-group">
                <label>Total Systems</label>
                <div class="badge health-green" id="stat-total" style="font-size: 1rem; padding: 8px 15px;">0</div>
            </div>
        </div>

        <div class="action-bar">
            <input type="text" id="search-bar" placeholder="Enter filter value..." oninput="currentPage=1; applyCurrentView()">
            <div id="pagination-controls" style="display:flex; align-items:center; gap:10px;"></div>
            <select id="page-size" onchange="changePageSize(this.value)" class="btn">
                <option value="25">25 Rows</option><option value="50">50 Rows</option><option value="1000">All</option>
            </select>
        </div>

        <div class="table-container">
            <table><thead id="table-head"></thead><tbody id="table-body"></tbody></table>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section"><h4 id="footer-title">...</h4><p id="footer-desc" style="font-size: 0.8rem;"></p></div>
            <div class="footer-section"><h4>Resources</h4><div id="footer-links"></div></div>
        </div>
        <div class="footer-bottom"><div id="footer-org"></div></div>
    </footer>
</div>

<div id="api-output" style="display:none;"></div>

<script>
    let rawSystems = [];
    let currentData = [];
    let currentPage = 1;
    let pageSize = 25;

    async function loadConfig() {
        const res = await fetch('config.json?t=' + Date.now());
        const conf = await res.json();
        document.title = conf.dashboardTitle;
        document.getElementById('display-title').innerText = conf.dashboardTitle;
        document.getElementById('footer-title').innerText = conf.footer.title;
        document.getElementById('footer-desc').innerText = conf.footer.description;
        document.getElementById('footer-org').innerText = `¬© 2026 ${conf.footer.orgName}`;
        document.getElementById('footer-links').innerHTML = conf.footer.resources.map(l => `<a href="${l.url}" target="_blank" style="font-size:0.8rem; color:inherit; display:block; margin-bottom:5px;">üîó ${l.label}</a>`).join('');
    }

    async function init() {
        const response = await fetch('data.json?t=' + Date.now());
        const data = await response.json();
        rawSystems = data.Systems;
        
        // Populate Filter Column Dropdown once
        if (document.getElementById('filter-col').options.length === 1) {
            Object.keys(rawSystems[0]).forEach(key => {
                let opt = document.createElement('option'); opt.value = key; opt.innerText = key;
                document.getElementById('filter-col').appendChild(opt);
            });
        }
        
        updateHeader(data.LastUpdated);
        handleApiMode(); // Check if we need to output raw text for IRM
        applyCurrentView();
    }

    function handleApiMode() {
        const params = new URLSearchParams(window.location.search);
        const nameFilter = params.get('name');
        const format = params.get('format');

        if (nameFilter && format === 'json') {
            const match = rawSystems.find(s => s.Name.toLowerCase() === nameFilter.toLowerCase());
            document.getElementById('dashboard-ui').style.display = 'none';
            document.getElementById('api-output').style.display = 'block';
            document.getElementById('api-output').innerHTML = `<pre>${JSON.stringify(match || {error: "Not Found"}, null, 2)}</pre>`;
        }
    }

    function applyCurrentView() {
        const term = document.getElementById('search-bar').value;
        const col = document.getElementById('filter-col').value;
        const isExact = document.getElementById('match-mode').value === 'exact';
        const isCase = document.getElementById('case-sensitive').checked;

        currentData = rawSystems.filter(s => {
            const fieldsToSearch = col === 'all' ? Object.values(s) : [s[col]];
            return fieldsToSearch.some(val => {
                let v = String(val);
                let t = String(term);
                
                if (!isCase) { v = v.toLowerCase(); t = t.toLowerCase(); }
                if (t === "") return true;
                return isExact ? v === t : v.includes(t);
            });
        });

        document.getElementById('stat-total').innerText = currentData.length;
        renderTable();
    }

    function renderTable() {
        const body = document.getElementById('table-body');
        const head = document.getElementById('table-head');
        const cols = Object.keys(rawSystems[0]);
        head.innerHTML = `<tr>${cols.map(c => `<th onclick="sortTable('${c}')">${c} ‚Üï</th>`).join('')}</tr>`;
        
        const start = (currentPage - 1) * pageSize;
        const displayData = currentData.slice(start, start + parseInt(pageSize));
        
        body.innerHTML = displayData.map(row => `<tr>${cols.map(c => {
            let val = row[c] || '';
            if (c === 'ChecksPassed') {
                const [p, t] = val.split('/').map(Number);
                return `<td data-label="${c}"><span class="badge ${(p/t)===1?'health-green':'health-red'}">${val}</span></td>`;
            }
            return `<td data-label="${c}">${val}</td>`;
        }).join('')}</tr>`).join('') || '<tr><td colspan="100%" style="text-align:center;">No matches</td></tr>';
        
        renderPagination();
    }

    function renderPagination() {
        const container = document.getElementById('pagination-controls');
        const totalPages = Math.ceil(currentData.length / pageSize);
        if (totalPages <= 1) { container.innerHTML = ''; return; }
        container.innerHTML = `
            <button class="btn" onclick="changePage(${currentPage-1})" ${currentPage===1?'disabled':''}>Prev</button>
            <span style="font-size:0.8rem; font-weight:600;">${currentPage} / ${totalPages}</span>
            <button class="btn" onclick="changePage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>Next</button>
        `;
    }

    function changePage(p) { currentPage = p; renderTable(); window.scrollTo(0,0); }
    function changePageSize(s) { pageSize = s; currentPage = 1; renderTable(); }
    function sortTable(c) { currentData.sort((a,b) => a[c] > b[c] ? 1 : -1); renderTable(); }
    function updateHeader(ts) { document.getElementById('update-time').innerText = `Scan: ${new Date(ts).toLocaleTimeString()}`; }
    function setTheme(v) { document.documentElement.setAttribute('data-theme',v); localStorage.setItem('pref-theme',v); }
    
    function exportToCSV() {
        const cols = Object.keys(rawSystems[0]);
        const csv = [cols.join(','), ...currentData.map(r => cols.map(c => `"${r[c]}"`).join(','))].join('\n');
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download=`export.csv`; a.click();
    }

    const savedTheme = localStorage.getItem('pref-theme') || 'system';
    setTheme(savedTheme);
    document.getElementById('theme-select').value = savedTheme;
    loadConfig();
    init();
</script>
</body>
</html>

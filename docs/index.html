<!DOCTYPE html>
<html lang="en" data-theme="system">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title id="tab-title">System Dashboard</title>
    <style>
        :root {
            --bg-color: #f8fafc; --card-bg: #ffffff; --text-color: #0f172a;
            --accent-color: #2563eb; --border-color: #e2e8f0; --hover-bg: #f1f5f9;
            --red: #ef4444; --green: #22c55e; --footer-bg: #0f172a;
        }
        [data-theme="dark"] {
            --bg-color: #020617; --card-bg: #1e293b; --text-color: #f1f5f9;
            --accent-color: #38bdf8; --border-color: #334155; --hover-bg: #334155;
            --footer-bg: #010409;
        }
        @media (prefers-color-scheme: dark) {
            [data-theme="system"] {
                --bg-color: #020617; --card-bg: #1e293b; --text-color: #f1f5f9;
                --accent-color: #38bdf8; --border-color: #334155; --hover-bg: #334155;
                --footer-bg: #010409;
            }
        }

        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        .header { background: var(--card-bg); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; flex: 1; width: 100%; box-sizing: border-box; }

        /* Filter Panel */
        .filter-panel { background: var(--card-bg); padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #64748b; }
        
        /* Action Bar */
        .action-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 1.5rem; }
        input[type="text"], select { padding: 0.6rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); outline: none; }

        /* Table */
        .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { padding: 1rem; font-size: 0.75rem; text-transform: uppercase; background: var(--hover-bg); border-bottom: 2px solid var(--border-color); cursor: pointer; }
        td { padding: 1rem; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; }

        /* Minimalist Footer */
        footer { background: var(--footer-bg); color: #94a3b8; padding: 3rem 2rem; margin-top: auto; border-top: 1px solid var(--border-color); }
        .footer-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 2rem; }
        .footer-brand h4 { color: #fff; margin: 0 0 0.5rem 0; font-size: 1rem; }
        .footer-links { display: flex; gap: 20px; }
        .footer-links a { color: inherit; text-decoration: none; font-size: 0.85rem; }
        .footer-links a:hover { color: var(--accent-color); }

        .badge { padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 0.75rem; }
        .health-green { background: #dcfce7; color: #166534; } .health-red { background: #fee2e2; color: #991b1b; }
        .btn { padding: 0.6rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); cursor: pointer; font-size: 0.8rem; font-weight: 600; }
        
        #install-btn { display: none; background: var(--accent-color); color: white; border: none; }
    </style>
</head>
<body>

<div id="dashboard-ui">
    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <h2 id="display-title" style="margin:0;">...</h2>
            <button id="install-btn" class="btn">üì≤ Install App</button>
        </div>
        <div style="display:flex; gap:10px;">
            <select id="theme-select" class="btn" onchange="setTheme(this.value)">
                <option value="system">üåì System</option>
                <option value="light">‚òÄÔ∏è Light</option>
                <option value="dark">üåô Dark</option>
            </select>
            <button class="btn" onclick="exportToCSV()">üìÇ CSV</button>
        </div>
    </div>

    <div class="container">
        <div class="filter-panel">
            <div class="filter-group">
                <label>Field</label>
                <select id="filter-col" onchange="toggleNumericUI(); applyCurrentView()"><option value="all">All Fields</option></select>
            </div>
            
            <div class="filter-group" id="numeric-op-group" style="display:none;">
                <label>Logic</label>
                <select id="num-op" onchange="applyCurrentView()">
                    <option value="gt">&gt; Greater Than</option>
                    <option value="lt">&lt; Less Than</option>
                    <option value="eq">= Equal To</option>
                    <option value="gte">&ge; Greater/Equal</option>
                    <option value="lte">&le; Less/Equal</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Match</label>
                <select id="match-mode" onchange="applyCurrentView()">
                    <option value="like">Contains</option>
                    <option value="exact">Exact</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Value</label>
                <input type="text" id="search-bar" placeholder="Type to filter..." oninput="currentPage=1; applyCurrentView()">
            </div>

            <div style="flex-grow:1"></div>
            <div class="filter-group">
                <label>Count</label>
                <div class="badge health-green" id="stat-total">0</div>
            </div>
        </div>

        <div class="action-bar">
            <div id="pagination-controls" style="display:flex; gap:5px;"></div>
            <select id="page-size" onchange="changePageSize(this.value)" class="btn">
                <option value="25">25 Rows</option><option value="100">100 Rows</option><option value="1000">All</option>
            </select>
            <button class="btn" onclick="init()">üîÑ Sync</button>
        </div>

        <div class="table-container">
            <table><thead id="table-head"></thead><tbody id="table-body"></tbody></table>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-brand">
                <h4 id="footer-org-name">...</h4>
                <div id="footer-copyright" style="font-size:0.8rem; opacity:0.6;"></div>
            </div>
            <div class="footer-links" id="footer-links"></div>
        </div>
    </footer>
</div>

<div id="api-output" style="display:none;"></div>

<script>
    let rawSystems = [];
    let currentData = [];
    let currentPage = 1;
    let pageSize = 25;
    let deferredPrompt;

    // PWA Logic
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e;
        document.getElementById('install-btn').style.display = 'block';
    });
    document.getElementById('install-btn').addEventListener('click', async () => {
        if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; document.getElementById('install-btn').style.display = 'none'; }
    });

    async function loadConfig() {
        const res = await fetch('config.json?t=' + Date.now());
        const conf = await res.json();
        document.getElementById('display-title').innerText = conf.dashboardTitle;
        document.getElementById('footer-org-name').innerText = conf.footer.orgName;
        document.getElementById('footer-copyright').innerText = `¬© 2026 ${conf.footer.orgName}. Internal Dashboard.`;
        document.getElementById('footer-links').innerHTML = conf.footer.resources.map(l => `<a href="${l.url}" target="_blank">${l.label}</a>`).join('');
    }

    function toggleNumericUI() {
        const col = document.getElementById('filter-col').value;
        const val = rawSystems[0][col];
        const isNumeric = !isNaN(parseFloat(val)) && isFinite(val);
        document.getElementById('numeric-op-group').style.display = isNumeric ? 'flex' : 'none';
        document.getElementById('match-mode').style.display = isNumeric ? 'none' : 'block';
    }

    async function init() {
        const res = await fetch('data.json?t=' + Date.now());
        const data = await res.json();
        rawSystems = data.Systems;
        if (document.getElementById('filter-col').options.length === 1) {
            Object.keys(rawSystems[0]).forEach(k => {
                let o = document.createElement('option'); o.value = k; o.innerText = k;
                document.getElementById('filter-col').appendChild(o);
            });
        }
        applyCurrentView();
    }

    function applyCurrentView() {
        const term = document.getElementById('search-bar').value.toLowerCase();
        const col = document.getElementById('filter-col').value;
        const op = document.getElementById('num-op').value;
        const isExact = document.getElementById('match-mode').value === 'exact';

        currentData = rawSystems.filter(s => {
            if (col === 'all') return Object.values(s).some(v => String(v).toLowerCase().includes(term));
            
            let val = s[col];
            let isNumeric = !isNaN(parseFloat(val)) && isFinite(val);

            if (isNumeric && term !== "") {
                let nVal = parseFloat(val);
                let nTerm = parseFloat(term);
                if (op === 'gt') return nVal > nTerm;
                if (op === 'lt') return nVal < nTerm;
                if (op === 'eq') return nVal === nTerm;
                if (op === 'gte') return nVal >= nTerm;
                if (op === 'lte') return nVal <= nTerm;
            }

            let strV = String(val).toLowerCase();
            return isExact ? strV === term : strV.includes(term);
        });

        document.getElementById('stat-total').innerText = currentData.length;
        renderTable();
    }

    function renderTable() {
        const body = document.getElementById('table-body');
        const head = document.getElementById('table-head');
        const cols = Object.keys(rawSystems[0]);
        head.innerHTML = `<tr>${cols.map(c => `<th onclick="sortTable('${c}')">${c} ‚Üï</th>`).join('')}</tr>`;
        const start = (currentPage - 1) * pageSize;
        const slice = currentData.slice(start, start + parseInt(pageSize));
        body.innerHTML = slice.map(r => `<tr>${cols.map(c => `<td data-label="${c}">${r[c]}</td>`).join('')}</tr>`).join('');
        renderPagination();
    }

    function renderPagination() {
        const container = document.getElementById('pagination-controls');
        const totalPages = Math.ceil(currentData.length / pageSize);
        if (totalPages <= 1) { container.innerHTML = ''; return; }
        container.innerHTML = `<button class="btn" onclick="changePage(${currentPage-1})" ${currentPage===1?'disabled':''}>Prev</button>
        <span style="font-size:0.8rem; font-weight:bold;">${currentPage} / ${totalPages}</span>
        <button class="btn" onclick="changePage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>Next</button>`;
    }

    function changePage(p) { currentPage = p; renderTable(); window.scrollTo(0,0); }
    function changePageSize(s) { pageSize = s; currentPage = 1; renderTable(); }
    function sortTable(c) { currentData.sort((a,b) => a[c] > b[c] ? 1 : -1); renderTable(); }
    function setTheme(v) { document.documentElement.setAttribute('data-theme', v); localStorage.setItem('pref-theme', v); }

    function exportToCSV() {
        const cols = Object.keys(rawSystems[0]);
        const csv = [cols.join(','), ...currentData.map(r => cols.map(c => `"${r[c]}"`).join(','))].join('\n');
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download=`export.csv`; a.click();
    }

    setTheme(localStorage.getItem('pref-theme') || 'system');
    loadConfig();
    init();
</script>
</body>
</html>

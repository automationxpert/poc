<!DOCTYPE html>
<html lang="en" data-theme="system">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="tab-title">System Dashboard</title>
    <style>
        :root {
            --bg-color: #f1f5f9; --card-bg: #ffffff; --text-color: #0f172a;
            --accent-color: #2563eb; --border-color: #e2e8f0; --hover-bg: #f8fafc;
            --red: #ef4444; --orange: #f97316; --yellow: #eab308; --green: #22c55e;
            --footer-bg: #0f172a;
        }
        [data-theme="dark"] {
            --bg-color: #020617; --card-bg: #1e293b; --text-color: #f1f5f9;
            --accent-color: #38bdf8; --border-color: #334155; --hover-bg: #334155;
            --footer-bg: #010409;
        }
        @media (prefers-color-scheme: dark) {
            [data-theme="system"] {
                --bg-color: #020617; --card-bg: #1e293b; --text-color: #f1f5f9;
                --accent-color: #38bdf8; --border-color: #334155; --hover-bg: #334155;
                --footer-bg: #010409;
            }
        }

        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; min-height: 100vh; transition: background 0.3s; }
        
        /* Header */
        .header { background: var(--card-bg); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-brand h2 { margin: 0; font-size: 1.25rem; font-weight: 800; letter-spacing: -0.025em; }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; flex: 1; width: 100%; box-sizing: border-box; }

        /* Advanced Filter Panel */
        .filter-panel { background: var(--card-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em; }
        
        /* Action Bar */
        .action-bar { display: flex; gap: 12px; align-items: center; margin-bottom: 1.5rem; background: var(--card-bg); padding: 0.75rem 1.25rem; border-radius: 12px; border: 1px solid var(--border-color); position: sticky; top: 85px; z-index: 900; }
        
        input[type="text"], select { padding: 0.6rem 0.8rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); outline: none; font-size: 0.9rem; transition: border 0.2s; }
        input[type="text"]:focus { border-color: var(--accent-color); }

        /* Table UI */
        .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow-x: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { padding: 1rem; font-size: 0.75rem; text-transform: uppercase; background: var(--hover-bg); border-bottom: 2px solid var(--border-color); cursor: pointer; color: #64748b; }
        th:hover { color: var(--accent-color); }
        td { padding: 1rem; border-bottom: 1px solid var(--border-color); font-size: 0.875rem; line-height: 1.5; }
        tr:last-child td { border: none; }
        tr:hover td { background: var(--hover-bg); }

        /* Professional Footer */
        footer { background: var(--footer-bg); color: #94a3b8; padding: 4rem 2rem 2rem 2rem; margin-top: 4rem; border-top: 4px solid var(--accent-color); }
        .footer-content { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 4rem; }
        .footer-section h4 { color: #ffffff; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1.5rem; }
        .footer-links-grid { display: flex; flex-direction: column; gap: 0.75rem; }
        .footer-links-grid a { color: #94a3b8; text-decoration: none; font-size: 0.9rem; transition: color 0.2s; }
        .footer-links-grid a:hover { color: var(--accent-color); }
        .footer-bottom { max-width: 1400px; margin: 4rem auto 0; padding-top: 2rem; border-top: 1px solid #1e293b; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }

        /* Badges & Buttons */
        .badge { padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 0.75rem; }
        .health-green { background: #dcfce7; color: #166534; }
        .health-red { background: #fee2e2; color: #991b1b; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; }
        .btn:hover { border-color: var(--accent-color); background: var(--hover-bg); }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }

        @media (max-width: 900px) {
            .footer-content { grid-template-columns: 1fr; gap: 2.5rem; }
            thead { display: none; }
            tr { display: block; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 12px; }
            td { display: flex; justify-content: space-between; border: none; padding: 0.75rem 1rem; text-align: right; }
            td::before { content: attr(data-label); font-weight: bold; text-align: left; color: #64748b; font-size: 0.7rem; text-transform: uppercase; }
        }
    </style>
</head>
<body>

<div id="dashboard-ui">
    <div class="header">
        <div class="header-brand">
            <h2 id="display-title">...</h2>
            <span id="update-time" style="font-size: 0.75rem; font-weight: 600; opacity: 0.5;">Syncing...</span>
        </div>
        <div style="display:flex; gap:12px;">
            <select id="theme-select" class="btn" onchange="setTheme(this.value)">
                <option value="system">üåì System</option>
                <option value="light">‚òÄÔ∏è Light</option>
                <option value="dark">üåô Dark</option>
            </select>
            <button class="btn" onclick="exportToCSV()">üìÇ Export CSV</button>
        </div>
    </div>

    <div class="container">
        <div class="filter-panel">
            <div class="filter-group">
                <label>Filter Column</label>
                <select id="filter-col" onchange="applyCurrentView()"><option value="all">Search All Fields</option></select>
            </div>
            <div class="filter-group">
                <label>Match Mode</label>
                <select id="match-mode" onchange="applyCurrentView()">
                    <option value="like">Matches (Like)</option>
                    <option value="exact">Exact Equal</option>
                </select>
            </div>
            <div class="filter-group" style="padding-bottom: 10px;">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="case-sensitive" onchange="applyCurrentView()" style="margin-right:8px;">
                    Case Sensitive
                </label>
            </div>
            <div style="flex-grow: 1;"></div>
            <div class="filter-group">
                <label>Filtered Results</label>
                <div class="badge health-green" id="stat-total" style="font-size: 1rem; padding: 8px 16px;">0</div>
            </div>
        </div>

        <div class="action-bar">
            <input type="text" id="search-bar" placeholder="Enter keyword to filter..." oninput="currentPage=1; applyCurrentView()" style="flex-grow: 1;">
            <div id="pagination-controls" style="display:flex; align-items:center; gap:8px;"></div>
            <select id="page-size" onchange="changePageSize(this.value)" class="btn">
                <option value="25">25 Rows</option><option value="50">50 Rows</option><option value="100">100 Rows</option><option value="1000">Show All</option>
            </select>
            <button class="btn" onclick="init()">üîÑ</button>
        </div>

        <div class="table-container">
            <table><thead id="table-head"></thead><tbody id="table-body"></tbody></table>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <div id="footer-org-name" style="color:white; font-weight:800; font-size: 1.1rem;">...</div>
                <p id="footer-desc" style="margin-top: 1rem; font-size: 0.85rem; color: #64748b;"></p>
            </div>
            <div class="footer-section">
                <h4 id="footer-links-title">Resources</h4>
                <div id="footer-links" class="footer-links-grid"></div>
            </div>
            <div class="footer-section">
                <h4>System Architecture</h4>
                <p style="font-size: 0.8rem; color: #475569;">
                    Frontend: Vanilla JS / CSS3<br>
                    Storage: GitHub Pages (Static)<br>
                    Pipeline: PowerShell Automation
                </p>
            </div>
        </div>
        <div class="footer-bottom">
            <div id="footer-copyright"></div>
            <div style="display:flex; gap:20px; opacity:0.6;">
                <span>v12.0 Stable</span>
                <span>Encrypted Push Active</span>
            </div>
        </div>
    </footer>
</div>

<div id="api-output" style="display:none; background:#0f172a; min-height:100vh; color:#38bdf8; padding:2rem; font-family:monospace;"></div>

<script>
    let rawSystems = [];
    let currentData = [];
    let lastDataStr = "";
    let currentPage = 1;
    let pageSize = 25;

    async function loadConfig() {
        try {
            const res = await fetch('config.json?t=' + Date.now());
            const conf = await res.json();
            document.title = conf.dashboardTitle;
            document.getElementById('display-title').innerText = conf.dashboardTitle;
            document.getElementById('footer-org-name').innerText = conf.footer.orgName;
            document.getElementById('footer-desc').innerText = conf.footer.description;
            document.getElementById('footer-links-title').innerText = conf.footer.title;
            document.getElementById('footer-copyright').innerText = `¬© 2026 ${conf.footer.orgName}. Internal Use Only.`;
            document.getElementById('footer-links').innerHTML = conf.footer.resources.map(l => `<a href="${l.url}" target="_blank">‚Üí ${l.label}</a>`).join('');
        } catch (e) { console.error("Config missing"); }
    }

    async function init() {
        try {
            const response = await fetch('data.json?t=' + Date.now());
            const text = await response.text();
            if (text === lastDataStr) return;
            lastDataStr = text;
            const data = JSON.parse(text);
            rawSystems = data.Systems;
            
            if (document.getElementById('filter-col').options.length === 1 && rawSystems.length > 0) {
                Object.keys(rawSystems[0]).forEach(key => {
                    let opt = document.createElement('option'); opt.value = key; opt.innerText = key;
                    document.getElementById('filter-col').appendChild(opt);
                });
            }
            
            updateHeader(data.LastUpdated);
            handleApiMode();
            applyCurrentView();
        } catch (e) { document.getElementById('update-time').innerText = "Offline"; }
    }

    setInterval(init, 120000);

    function handleApiMode() {
        const p = new URLSearchParams(window.location.search);
        if (p.get('format') === 'json') {
            const name = p.get('name');
            const match = name ? rawSystems.find(s => s.Name.toLowerCase() === name.toLowerCase()) : rawSystems;
            document.getElementById('dashboard-ui').style.display = 'none';
            document.getElementById('api-output').style.display = 'block';
            document.getElementById('api-output').innerHTML = `<pre>${JSON.stringify(match || {error:"Not Found"}, null, 2)}</pre>`;
        }
    }

    function applyCurrentView() {
        const term = document.getElementById('search-bar').value;
        const col = document.getElementById('filter-col').value;
        const isExact = document.getElementById('match-mode').value === 'exact';
        const isCase = document.getElementById('case-sensitive').checked;

        currentData = rawSystems.filter(s => {
            const fields = col === 'all' ? Object.values(s) : [s[col]];
            return fields.some(val => {
                let v = String(val), t = String(term);
                if (!isCase) { v = v.toLowerCase(); t = t.toLowerCase(); }
                return t === "" ? true : (isExact ? v === t : v.includes(t));
            });
        });

        document.getElementById('stat-total').innerText = currentData.length;
        renderTable();
    }

    function renderTable() {
        const body = document.getElementById('table-body');
        const head = document.getElementById('table-head');
        if (!rawSystems[0]) return;
        const cols = Object.keys(rawSystems[0]);

        head.innerHTML = `<tr>${cols.map(c => `<th onclick="sortTable('${c}')">${c} ‚Üï</th>`).join('')}</tr>`;
        
        const start = (currentPage - 1) * pageSize;
        const displayData = currentData.slice(start, start + parseInt(pageSize));
        
        body.innerHTML = displayData.map(row => `<tr>${cols.map(c => {
            let val = row[c] || '';
            if (c === 'ChecksPassed') {
                const [p, t] = val.split('/').map(Number);
                return `<td data-label="${c}"><span class="badge ${(p/t)===1?'health-green':'health-red'}">${val}</span></td>`;
            }
            return `<td data-label="${c}">${val}</td>`;
        }).join('')}</tr>`).join('') || '<tr><td colspan="100%" style="text-align:center; padding:3rem;">No matching systems found.</td></tr>';
        
        renderPagination();
    }

    function renderPagination() {
        const container = document.getElementById('pagination-controls');
        const totalPages = Math.ceil(currentData.length / pageSize);
        if (totalPages <= 1) { container.innerHTML = ''; return; }
        container.innerHTML = `
            <button class="btn" onclick="changePage(${currentPage-1})" ${currentPage===1?'disabled':''}>Prev</button>
            <span style="font-size:0.85rem; font-weight:700;">${currentPage} / ${totalPages}</span>
            <button class="btn" onclick="changePage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>Next</button>
        `;
    }

    function changePage(p) { currentPage = p; renderTable(); window.scrollTo(0,0); }
    function changePageSize(s) { pageSize = s; currentPage = 1; renderTable(); }
    function sortTable(c) { currentData.sort((a,b) => a[c] > b[c] ? 1 : -1); renderTable(); }
    function updateHeader(ts) { document.getElementById('update-time').innerText = `Updated: ${new Date(ts).toLocaleTimeString()}`; }
    function setTheme(v) { document.documentElement.setAttribute('data-theme',v); localStorage.setItem('pref-theme',v); }
    
    function exportToCSV() {
        const cols = Object.keys(rawSystems[0]);
        const csv = [cols.join(','), ...currentData.map(r => cols.map(c => `"${r[c]}"`).join(','))].join('\n');
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download=`inventory_export.csv`; a.click();
    }

    const savedTheme = localStorage.getItem('pref-theme') || 'system';
    setTheme(savedTheme);
    document.getElementById('theme-select').value = savedTheme;
    loadConfig();
    init();
</script>
</body>
</html>
